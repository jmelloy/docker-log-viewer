<div class="app-container">
  <app-header></app-header>

  <div class="main-layout">
    <aside class="sidebar">
      <div class="section">
        <h3>Sample Queries</h3>
        <button @click="openNewSampleQueryModal" class="btn-primary">
          + New Sample Query
        </button>
        <div class="requests-list">
          <p v-if="sampleQueries.length === 0" style="padding: 1rem; color: #6c757d; text-align: center;">No sample queries yet</p>
          <div v-for="sq in sampleQueries" 
               :key="sq.id"
               class="request-item"
               :class="{ 'selected': isSampleQuerySelected(sq.id) }"
               @click="openExecuteModalWithSampleQuery(sq)">
            <div class="request-item-name">{{ getSampleQueryDisplayName(sq) }}</div>
            <div class="request-item-meta">
              <span>{{ sq.server?.url || 'No server' }}</span>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="empty-state">
        <div class="flex-between mb-1">
          <h2 class="m-0">All Requests</h2>
          <div class="flex-center">
            <button @click="openExecuteNewModal" class="btn-primary">
              ▶ Execute Request
            </button>
            <button
              v-if="compareButtonVisible"
              @click="compareSelectedRequests"
              class="btn-primary">
              Compare Selected
            </button>
          </div>
        </div>
        <div class="flex-center mb-1">
          <input 
            type="text" 
            v-model="searchQuery" 
            @input="handleSearchChange"
            placeholder="Search requests..." 
            class="search-input-full"
          />
        </div>
        <div class="executions-list">
          <p v-if="allRequests.length === 0" class="text-muted">No requests executed yet. Click "Execute Request" to get started.</p>
          <div v-for="req in allRequests" 
               :key="req.id"
               class="execution-item-compact"
               @click="handleExecutionClick(req, $event)">
            <input type="checkbox" class="exec-compare-checkbox" :data-id="req.id" :checked="selectedRequestIds.includes(req.id)" @change="updateCompareButton">
            <span class="exec-status" :class="getExecutionStatusClass(req)">{{ req.statusCode || 'ERR' }}</span>
            <span class="exec-name">{{ req.displayName }}</span>
            <span class="exec-time">{{ getExecutionTimeString(req) }}</span>
            <span class="exec-server">{{ getExecutionServerUrl(req) }}</span>
            <span class="exec-duration">{{ req.durationMs }}ms</span>
            <span class="exec-id">{{ req.requestIdHeader }}</span>
          </div>
        </div>
        <div v-if="totalPages > 1" class="pagination">
          <button @click="changePage(1)" :disabled="!hasPrevPage" class="btn-secondary">« First</button>
          <button @click="changePage(currentPage - 1)" :disabled="!hasPrevPage" class="btn-secondary">‹ Prev</button>
          <span>Page {{ currentPage }} of {{ totalPages }}</span>
          <button @click="changePage(currentPage + 1)" :disabled="!hasNextPage" class="btn-secondary">Next ›</button>
          <button @click="changePage(totalPages)" :disabled="!hasNextPage" class="btn-secondary">Last »</button>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- New Sample Query Modal -->
<div v-if="showNewSampleQueryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>New Sample Query</h3>
      <button @click="showNewSampleQueryModal = false">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="newSampleQueryName">Name:</label>
        <input
          type="text"
          id="newSampleQueryName"
          v-model="newQueryForm.name"
          placeholder="e.g., FetchUsers"
          required
        />
      </div>
      <div class="form-group">
        <label for="newSampleQueryServer">Server (optional):</label>
        <select id="newSampleQueryServer" v-model="newQueryForm.serverId" :disabled="newQueryForm.createNewServer">
          <option value="">-- No Server --</option>
          <option v-for="server in servers" :key="server.id" :value="server.id">
            {{ server.name }} ({{ server.url }})
          </option>
        </select>
      </div>
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" v-model="newQueryForm.createNewServer" @change="newQueryForm.createNewServer && (newQueryForm.serverId = '')">
          <span>Create New Server</span>
        </label>
      </div>
      <div v-if="showNewServerFields">
        <div class="form-group">
          <label for="newSampleQueryURL">URL (optional):</label>
          <input
            type="text"
            id="newSampleQueryURL"
            v-model="newQueryForm.url"
            placeholder="https://api.example.com/graphql"
          />
        </div>
        <div class="form-group">
          <label for="newSampleQueryToken">Bearer Token (optional):</label>
          <input
            type="text"
            id="newSampleQueryToken"
            v-model="newQueryForm.bearerToken"
            placeholder="your-token-here"
          />
        </div>
        <div class="form-group">
          <label for="newSampleQueryDevID">Dev ID (optional):</label>
          <input
            type="text"
            id="newSampleQueryDevID"
            v-model="newQueryForm.devId"
            placeholder="dev-user-id"
          />
        </div>
      </div>
      <div class="form-group">
        <label for="newSampleQueryData">Query Data (JSON):</label>
        <textarea
          id="newSampleQueryData"
          v-model="newQueryForm.requestData"
          rows="15"
          placeholder='{"query": "{ users { id name } }"}'
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button @click="saveNewSampleQuery" class="btn-primary">
        Save Sample Query
      </button>
      <button @click="showNewSampleQueryModal = false" class="btn-secondary">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Execute New Request Modal -->
<div v-if="showExecuteNewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Execute Request</h3>
      <button @click="showExecuteNewModal = false">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="executeNewQuery">Sample Query:</label>
        <select id="executeNewQuery" v-model="selectedSampleQuery" @change="selectSampleQueryForExecution">
          <option :value="null">-- Select Sample Query --</option>
          <option v-for="sq in sampleQueries" :key="sq.id" :value="sq">
            {{ getSampleQueryDisplayName(sq) }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="executeRequestData">Request Data:</label>
        <textarea 
          id="executeRequestData" 
          v-model="executeForm.requestDataOverride" 
          placeholder="Enter or edit request data (JSON)"
          rows="10"
          style="font-family: monospace; font-size: 0.875rem;"
        ></textarea>
      </div>
      <div class="form-group">
        <label for="executeServer">Server:</label>
        <select id="executeServer" v-model="executeForm.serverId" @change="selectSampleQueryForExecution">
          <option value="">-- Select Server --</option>
          <option v-for="server in servers" :key="server.id" :value="server.id">
            {{ server.name }} ({{ server.url }})
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="executeToken">Bearer Token Override (optional):</label>
        <input type="text" id="executeToken" v-model="executeForm.tokenOverride" placeholder="Override token" />
      </div>
      <div class="form-group">
        <label for="executeDevID">Dev ID Override (optional):</label>
        <input
          type="text"
          id="executeDevID"
          v-model="executeForm.devIdOverride"
          placeholder="Override dev ID"
        />
      </div>

      <div v-if="Object.keys(executeForm.graphqlVariables).length > 0" class="form-group" style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <label style="margin: 0;">GraphQL Variables:</label>
          <button @click="addGraphQLVariable" class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">+ Add Variable</button>
        </div>
        <div style="background: #0d1117; border: 1px solid #30363d; border-radius: 4px; padding: 1rem;">
          <div v-for="(value, key) in executeForm.graphqlVariables" :key="key" style="margin-bottom: 0.75rem;">
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.25rem;">
              <label style="min-width: 120px; color: #79c0ff; font-family: monospace; font-size: 0.875rem;">{{ key }}:</label>
              <button @click="removeGraphQLVariable(key)" style="background: #da3633; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-left: auto;">Remove</button>
            </div>
            <textarea
              :value="typeof value === 'string' ? value : JSON.stringify(value, null, 2)"
              @input="updateGraphQLVariable(key, $event.target.value)"
              style="width: 100%; background: #161b22; border: 1px solid #30363d; color: #c9d1d9; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; min-height: 60px; resize: vertical;"
              placeholder="Enter value (JSON if object/array)"
            ></textarea>
          </div>
        </div>
      </div>
      <div v-else class="form-group" style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <label style="margin: 0;">GraphQL Variables:</label>
          <button @click="addGraphQLVariable" class="btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">+ Add Variable</button>
        </div>
        <p style="color: #8b949e; font-size: 0.875rem; margin: 0;">No variables found in request body. Click "Add Variable" to add one.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button @click="executeSelectedQuery" class="btn-primary">Execute</button>
      <button @click="showExecuteNewModal = false" class="btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Request Comparison Modal -->
<div v-if="showComparisonModal && comparisonData" class="modal">
  <div class="modal-content" style="max-width: 1400px">
    <div class="modal-header">
      <h3>Request Comparison</h3>
      <button @click="showComparisonModal = false">✕</button>
    </div>
    <div class="modal-body">
      <div class="comparison-grid">
        <div class="comparison-column">
          <h3>Request 1</h3>
          <div class="comparison-stats">
            <div><strong>Status:</strong> {{ comparisonData.detail1.execution.statusCode }}</div>
            <div><strong>Duration:</strong> {{ comparisonData.detail1.execution.durationMs }}ms</div>
            <div><strong>Request ID:</strong> {{ comparisonData.detail1.execution.requestIdHeader }}</div>
            <div><strong>Executed:</strong> {{ new Date(comparisonData.detail1.execution.executedAt).toLocaleString() }}</div>
          </div>
          <div class="comparison-section">
            <h4>Response</h4>
            <pre class="json-display">{{ comparisonData.detail1.execution.responseBody || 'No response' }}</pre>
          </div>
          <div class="comparison-section">
            <h4>SQL Queries ({{ comparisonData.detail1.sqlQueries.length }})</h4>
            <div class="comparison-queries">
              <div v-for="(q, idx) in comparisonData.detail1.sqlQueries" :key="idx" class="comparison-query">
                <div><strong>{{ q.tableName }}</strong> - {{ q.durationMs.toFixed(2) }}ms</div>
                <div class="sql-query-text">{{ formatSQL(q.query) }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="comparison-divider">
          <div class="comparison-diff">
            <div>Time Difference</div>
            <div :class="getComparisonTimeDiffClass()">
              {{ getComparisonTimeDiff() > 0 ? '+' : '' }}{{ getComparisonTimeDiff() }}ms 
              ({{ getComparisonTimeDiff() > 0 ? '+' : '' }}{{ getComparisonTimeDiffPercent() }}%)
            </div>
          </div>
        </div>

        <div class="comparison-column">
          <h3>Request 2</h3>
          <div class="comparison-stats">
            <div><strong>Status:</strong> {{ comparisonData.detail2.execution.statusCode }}</div>
            <div><strong>Duration:</strong> {{ comparisonData.detail2.execution.durationMs }}ms</div>
            <div><strong>Request ID:</strong> {{ comparisonData.detail2.execution.requestIdHeader }}</div>
            <div><strong>Executed:</strong> {{ new Date(comparisonData.detail2.execution.executedAt).toLocaleString() }}</div>
          </div>
          <div class="comparison-section">
            <h4>Response</h4>
            <pre class="json-display">{{ comparisonData.detail2.execution.responseBody || 'No response' }}</pre>
          </div>
          <div class="comparison-section">
            <h4>SQL Queries ({{ comparisonData.detail2.sqlQueries.length }})</h4>
            <div class="comparison-queries">
              <div v-for="(q, idx) in comparisonData.detail2.sqlQueries" :key="idx" class="comparison-query">
                <div><strong>{{ q.tableName }}</strong> - {{ q.durationMs.toFixed(2) }}ms</div>
                <div class="sql-query-text">{{ formatSQL(q.query) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
