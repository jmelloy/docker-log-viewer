<div class="app-container">
  <app-header>
    <div class="header-controls">
      <div class="search-box">
        <input type="text" v-model="searchQuery" placeholder="Search logs...">
        <button @click="searchQuery = ''; updateURL()" class="clear-btn" title="Clear search">‚úï</button>
      </div>
      <div class="trace-filter-display" v-if="hasTraceFilters">
        <span v-for="([key, value], index) in Array.from(traceFilters.entries())" :key="key" class="trace-filter-badge">
          <span class="filter-key">{{ key }}</span>=<span class="filter-value">{{ value }}</span>
          <button @click="removeTraceFilter(key)" class="filter-remove" title="Remove filter">√ó</button>
        </span>
        <button @click="saveTrace" class="btn-star" title="Save trace to request manager">‚≠ê</button>
        <button @click="clearTraceFilters" class="clear-btn" title="Clear all filters">‚úï</button>
      </div>
    </div>
  </app-header>
  
  <div class="main-layout">
    <aside class="sidebar">
      <!-- SQL Query Analyzer Section -->
      <div v-if="showAnalyzer" class="section analyzer-section-container">
        <div class="section-header">
          <h3>SQL Query Analyzer</h3>
          <button @click="showAnalyzer = false" class="close-analyzer-btn">‚úï</button>
        </div>
        <div v-if="sqlAnalysis" class="analyzer-content-compact">
          <div class="analyzer-subsection">
            <h4>Overview</h4>
            <div class="stats-grid-compact">
              <div class="stat-item">
                <span class="stat-label">Total Queries</span>
                <span class="stat-value">{{ sqlAnalysis.totalQueries }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Unique</span>
                <span class="stat-value">{{ sqlAnalysis.uniqueQueries }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Avg Duration</span>
                <span class="stat-value">{{ sqlAnalysis.avgDuration.toFixed(2) }}ms</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Total Duration</span>
                <span class="stat-value">{{ sqlAnalysis.totalDuration.toFixed(2) }}ms</span>
              </div>
            </div>
          </div>

          <div class="analyzer-subsection">
            <h4>Slowest Queries</h4>
            <div class="query-list-compact">
              <div v-if="sqlAnalysis.slowestQueries.length === 0" class="query-item-compact">No SQL queries</div>
              <div v-for="(q, index) in sqlAnalysis.slowestQueries.slice(0, 3)" :key="index" class="query-item-compact">
                <div class="query-header-compact">
                  <span class="query-duration" :class="{ 'query-slow': q.duration > 10 }">{{ q.duration.toFixed(2) }}ms</span>
                  <span class="query-meta-inline">{{ q.table }} ¬∑ {{ q.operation }}</span>
                </div>
                <div class="query-text-compact">{{ q.query.substring(0, 60) }}{{ q.query.length > 60 ? '...' : '' }}</div>
                <button class="btn-explain-compact" @click="runExplain(q.query, q.variables, { table: q.table, operation: q.operation, type: 'slowest' })">EXPLAIN</button>
              </div>
            </div>
          </div>

          <div class="analyzer-subsection">
            <h4>Most Frequent</h4>
            <div class="query-list-compact">
              <div v-for="(item, index) in sqlAnalysis.frequentQueries.slice(0, 3)" :key="index" class="query-item-compact">
                <div class="query-header-compact">
                  <span class="query-count">{{ item.count }}x</span>
                  <span class="query-meta-inline">{{ item.example.table }} ¬∑ {{ item.avgDuration.toFixed(2) }}ms</span>
                </div>
                <div class="query-text-compact">{{ item.example.query.substring(0, 60) }}{{ item.example.query.length > 60 ? '...' : '' }}</div>
                <button class="btn-explain-compact" @click="runExplain(item.example.query, item.example.variables, { table: item.example.table, operation: item.example.operation, type: 'frequent' })">EXPLAIN</button>
              </div>
            </div>
          </div>

          <div v-if="sqlAnalysis.nPlusOne.length > 0" class="analyzer-subsection">
            <h4>N+1 Issues ({{ sqlAnalysis.nPlusOne.length }})</h4>
            <div class="query-list-compact">
              <div v-for="(item, index) in sqlAnalysis.nPlusOne.slice(0, 2)" :key="index" class="query-item-compact nplusone">
                <div class="query-header-compact">
                  <span class="query-count">{{ item.count }}x</span>
                  <span class="query-meta-inline">{{ item.example.table }}</span>
                </div>
                <div class="query-text-compact">{{ item.example.query.substring(0, 60) }}...</div>
              </div>
            </div>
          </div>

          <div class="analyzer-subsection">
            <h4>Tables</h4>
            <div class="table-list-compact">
              <span v-for="(item, index) in sqlAnalysis.tables" :key="index" class="table-badge-compact">
                {{ item.table }}<span class="table-count">({{ item.count }})</span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Containers</h3>
        <div class="container-list">
          <div v-for="project in projectNames" :key="project" class="project-section">
            <div class="project-header" @click="toggleProjectCollapse(project)">
              <span class="disclosure-arrow" :class="{ collapsed: isProjectCollapsed(project) }">‚ñº</span>
              <div class="checkbox" 
                   :class="{ checked: isProjectSelected(project), indeterminate: isProjectIndeterminate(project) }"
                   @click.stop="toggleProject(project)"></div>
              <span class="project-name">{{ project }}</span>
              <span class="project-count">({{ containersByProject[project].length }})</span>
            </div>
            <div class="project-containers" :class="{ collapsed: isProjectCollapsed(project) }">
              <div v-for="container in containersByProject[project]" 
                   :key="container.Name"
                   class="container-item"
                   :class="{ selected: isContainerSelected(container.Name) }">
                <div @click="toggleContainer(container.Name)" style="display: flex; flex: 1; align-items: center;">
                  <div class="checkbox" :class="{ checked: isContainerSelected(container.Name) }"></div>
                  <div class="container-info">
                    <div class="container-name">{{ container.Name }}</div>
                    <div class="container-id">{{ container.ID.substring(0, 12) }}</div>
                  </div>
                </div>
                <div class="log-count-badge" 
                     @click.stop="openRetentionModal(container.Name)" 
                     :title="getRetentionTooltip(container.Name)">
                  {{ logCounts[container.Name] || 0 }}
                  <span v-if="retentions[container.Name]" class="retention-indicator">‚è±</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="recentRequests.length > 0" class="section">
        <h3>Recent Requests</h3>
        <div class="recent-requests-list">
          <div v-for="req in recentRequests" :key="req.requestId" 
               class="recent-request-item"
               @click="setTraceFilter('request_id', req.requestId, null)"
               title="Click to filter by this request">
            <div class="request-header-line">
              <span class="request-method">{{ req.method }}</span>
              <span class="request-path">{{ req.path }}</span>
              <span v-if="req.latency" class="request-latency" :class="{ 'latency-slow': parseFloat(req.latency) > 1000 }">{{ parseFloat(req.latency).toFixed(0) }}ms</span>
              <span v-if="req.statusCode" class="request-status" :class="{ 'status-success': req.statusCode >= 200 && req.statusCode < 300, 'status-error': req.statusCode >= 400 }">{{ req.statusCode }}</span>
            </div>
            <div v-if="req.operations.length > 0" class="request-operations">
              <span v-for="op in req.operations" :key="op" class="operation-badge">{{ op }}</span>
            </div>
            <div class="request-footer">
              <span class="request-timestamp">{{ req.timestamp }}</span>
              <span class="request-id">{{ req.requestId.substring(0, 8) }}...</span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Log Levels</h3>
        <div class="level-filters">
          <label class="level-filter">
            <input type="checkbox" value="TRC" :checked="isLevelSelected('TRC')" @change="toggleLevel('TRC')">
            <span class="level-badge level-trc">TRC</span>
          </label>
          <label class="level-filter">
            <input type="checkbox" value="DBG" :checked="isLevelSelected('DBG')" @change="toggleLevel('DBG')">
            <span class="level-badge level-dbg">DBG</span>
          </label>
          <label class="level-filter">
            <input type="checkbox" value="INF" :checked="isLevelSelected('INF')" @change="toggleLevel('INF')">
            <span class="level-badge level-inf">INF</span>
          </label>
          <label class="level-filter">
            <input type="checkbox" value="WRN" :checked="isLevelSelected('WRN')" @change="toggleLevel('WRN')">
            <span class="level-badge level-wrn">WRN</span>
          </label>
          <label class="level-filter">
            <input type="checkbox" value="ERR" :checked="isLevelSelected('ERR')" @change="toggleLevel('ERR')">
            <span class="level-badge level-err">ERR</span>
          </label>
          <label class="level-filter">
            <input type="checkbox" value="NONE" :checked="isLevelSelected('NONE')" @change="toggleLevel('NONE')">
            <span class="level-badge level-none">NONE</span>
          </label>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="status">
          <span :style="{ color: statusColor }">{{ statusText }}</span>
          <span>{{ logCountText }}</span>
        </div>
      </div>
    </aside>

    <main class="log-viewer">
      <div ref="logsContainer" class="logs">
        <div v-for="(log, index) in filteredLogs" 
             :key="index"
             class="log-line"
             @click="openLogDetails(log)">
          <span class="log-container">{{ getContainerName(log.containerId) }}</span>
          <span v-if="log.entry?.timestamp" class="log-timestamp">{{ log.entry.timestamp }}</span>
          <span v-if="log.entry?.level" class="log-level" :class="log.entry.level">{{ log.entry.level }}</span>
          <span v-if="log.entry?.file" class="log-file">{{ log.entry.file }}</span>
          <span v-if="log.entry?.message" class="log-message">{{ log.entry.message }}</span>
          <span v-for="([key, value], idx) in Object.entries(log.entry?.fields || {})" 
                :key="idx"
                class="log-field">
            <span class="log-field-key">{{ key }}</span>=<span 
              :class="{ 'log-field-value': !isJsonField(value) }"
              @click.stop="!isJsonField(value) && setTraceFilter(key, value, $event)">{{ formatFieldValue(value) }}</span>
          </span>
        </div>
      </div>
    </main>


  </div>
</div>

<!-- Log Details Modal -->
<div v-if="showLogModal" class="modal" @click="showLogModal = false">
  <div class="modal-content" @click.stop>
    <div class="modal-header">
      <h3>Log Details</h3>
      <button @click="showLogModal = false">‚úï</button>
    </div>
    <div v-if="selectedLog" class="modal-body">
      <div class="modal-section">
        <h4>Raw Log</h4>
        <pre v-html="convertAnsiToHtml(selectedLog.entry?.raw || 'No raw log available')"></pre>
      </div>
      <div class="modal-section">
        <h4>Parsed Fields</h4>
        <div>
          <div v-if="selectedLog.entry?.timestamp" class="parsed-field">
            <div class="parsed-field-key">Timestamp</div>
            <div class="parsed-field-value">{{ selectedLog.entry.timestamp }}</div>
          </div>
          <div v-if="selectedLog.entry?.level" class="parsed-field">
            <div class="parsed-field-key">Level</div>
            <div class="parsed-field-value">{{ selectedLog.entry.level }}</div>
          </div>
          <div v-if="selectedLog.entry?.file" class="parsed-field">
            <div class="parsed-field-key">File</div>
            <div class="parsed-field-value">{{ selectedLog.entry.file }}</div>
          </div>
          <div v-if="selectedLog.entry?.message" class="parsed-field">
            <div class="parsed-field-key">Message</div>
            <div class="parsed-field-value">{{ selectedLog.entry.message }}</div>
          </div>
          <div v-for="([key, value], idx) in Object.entries(selectedLog.entry?.fields || {})" :key="idx" class="parsed-field">
            <div class="parsed-field-key">{{ key }}</div>
            <div v-if="isJsonField(value)" class="parsed-field-value">
              <pre>{{ formatJsonField(value) }}</pre>
            </div>
            <div v-else class="parsed-field-value">{{ value }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EXPLAIN Modal -->
<div v-if="showExplainModal" class="modal" @click="showExplainModal = false">
  <div class="modal-content explain-modal-content" @click.stop>
    <div class="modal-header">
      <h3>SQL Query Explain Plan (PEV2)</h3>
      <div style="display: flex; gap: 0.5rem;">
        <button v-if="!explainData.error" @click="shareExplainPlan" class="btn-share" title="Share on explain.dalibo.com">üîó Share</button>
        <button @click="showExplainModal = false">‚úï</button>
      </div>
    </div>
    <div class="modal-body">
      <div v-if="explainData.error" class="alert alert-danger" style="margin: 1rem;">{{ explainData.error }}</div>
      <div v-else id="pev2App" class="d-flex flex-column">
        <pev2 :plan-source="explainData.planSource" :plan-query="explainData.planQuery"></pev2>
      </div>
    </div>
  </div>
</div>

<!-- Retention Modal -->
<div v-if="showRetentionModal" class="modal" @click="showRetentionModal = false">
  <div class="modal-content" @click.stop style="max-width: 500px;">
    <div class="modal-header">
      <h3>Log Retention - {{ retentionContainer }}</h3>
      <button @click="showRetentionModal = false">‚úï</button>
    </div>
    <div class="modal-body" style="padding: 1.5rem;">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Retention Type:</label>
        <select v-model="retentionForm.type" style="width: 100%; padding: 0.5rem; border: 1px solid #30363d; background: #0d1117; color: #c9d1d9; border-radius: 6px;">
          <option value="count">By Count (number of logs)</option>
          <option value="time">By Time (seconds)</option>
        </select>
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
          {{ retentionForm.type === 'count' ? 'Maximum Logs:' : 'Maximum Age (seconds):' }}
        </label>
        <input 
          v-model.number="retentionForm.value" 
          type="number" 
          min="1"
          style="width: 100%; padding: 0.5rem; border: 1px solid #30363d; background: #0d1117; color: #c9d1d9; border-radius: 6px;"
          :placeholder="retentionForm.type === 'count' ? 'e.g., 1000' : 'e.g., 3600 (1 hour)'"
        />
      </div>
      <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button @click="saveRetention" class="btn-primary" style="padding: 0.5rem 1rem; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save
        </button>
        <button v-if="retentions[retentionContainer]" @click="deleteRetention" class="btn-danger" style="padding: 0.5rem 1rem; background: #da3633; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Remove
        </button>
        <button @click="showRetentionModal = false" style="padding: 0.5rem 1rem; background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; cursor: pointer;">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
