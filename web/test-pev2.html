<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEV2 Integration Test - Docker Log Viewer</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="pev2.css">
    <style>
        body {
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        }
        h1 {
            color: #58a6ff;
            margin-bottom: 2rem;
        }
        .test-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .test-section h2 {
            color: #7ee787;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        #pev2Container {
            height: 600px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
        }
        .status {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .status.success {
            background: #1a472a;
            border: 1px solid #2ea043;
            color: #7ee787;
        }
        .status.error {
            background: #1f1214;
            border: 1px solid #da3633;
            color: #f85149;
        }
        button {
            background: #238636;
            color: #fff;
            border: 1px solid #2ea043;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #2ea043;
        }
        pre {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 1rem;
            overflow-x: auto;
            color: #c9d1d9;
        }
    </style>
</head>
<body>
    <h1>ðŸ”¬ PEV2 Integration Test - Docker Log Viewer</h1>

    <div class="test-section">
        <h2>âœ“ Library Status</h2>
        <div id="libraryStatus"></div>
    </div>

    <div class="test-section">
        <h2>ðŸ§ª Test Controls</h2>
        <button onclick="loadSamplePlan()">Load Sample EXPLAIN Plan</button>
        <button onclick="loadComplexPlan()">Load Complex Plan</button>
        <button onclick="loadErrorState()">Load Error State</button>
    </div>

    <div class="test-section">
        <h2>ðŸ“Š PEV2 Visualization</h2>
        <div id="pev2Container"></div>
    </div>

    <script src="vue.global.prod.js"></script>
    <script src="pev2.umd.js"></script>
    <script>
        // Check library status
        function checkLibraries() {
            const status = document.getElementById('libraryStatus');
            let html = '';
            
            if (typeof Vue !== 'undefined') {
                html += '<div class="status success">âœ“ Vue 3 loaded successfully</div>';
            } else {
                html += '<div class="status error">âœ— Vue 3 failed to load</div>';
            }
            
            if (typeof pev2 !== 'undefined') {
                html += '<div class="status success">âœ“ PEV2 library loaded successfully</div>';
            } else {
                html += '<div class="status error">âœ— PEV2 library failed to load</div>';
            }
            
            status.innerHTML = html;
            return typeof Vue !== 'undefined' && typeof pev2 !== 'undefined';
        }

        let app = null;

        // Initialize PEV2
        function initPEV2() {
            if (!checkLibraries()) {
                console.error('Required libraries not loaded');
                return;
            }

            const { createApp } = Vue;
            app = createApp({
                data() {
                    return {
                        planSource: '',
                        planQuery: ''
                    }
                },
                methods: {
                    updatePlan(plan, query) {
                        this.planSource = plan;
                        this.planQuery = query;
                    }
                }
            });
            
            app.component('pev2', pev2.Plan);
            app.mount('#pev2Container');
            
            console.log('PEV2 initialized successfully');
        }

        // Sample PostgreSQL EXPLAIN plan (simple)
        function loadSamplePlan() {
            const plan = [
                {
                    "Plan": {
                        "Node Type": "Seq Scan",
                        "Relation Name": "users",
                        "Alias": "users",
                        "Startup Cost": 0.00,
                        "Total Cost": 155.00,
                        "Plan Rows": 10000,
                        "Plan Width": 4,
                        "Actual Startup Time": 0.010,
                        "Actual Total Time": 5.234,
                        "Actual Rows": 10000,
                        "Actual Loops": 1
                    },
                    "Planning Time": 0.123,
                    "Execution Time": 5.456
                }
            ];
            
            const query = "SELECT id FROM users";
            
            if (app && app._instance) {
                app._instance.proxy.updatePlan(JSON.stringify(plan, null, 2), query);
                console.log('Sample plan loaded');
            }
        }

        // Complex PostgreSQL EXPLAIN plan
        function loadComplexPlan() {
            const plan = [
                {
                    "Plan": {
                        "Node Type": "Hash Join",
                        "Join Type": "Inner",
                        "Startup Cost": 35.00,
                        "Total Cost": 450.50,
                        "Plan Rows": 5000,
                        "Plan Width": 32,
                        "Actual Startup Time": 2.345,
                        "Actual Total Time": 45.678,
                        "Actual Rows": 4856,
                        "Actual Loops": 1,
                        "Hash Cond": "(orders.user_id = users.id)",
                        "Plans": [
                            {
                                "Node Type": "Seq Scan",
                                "Parent Relationship": "Outer",
                                "Relation Name": "orders",
                                "Alias": "orders",
                                "Startup Cost": 0.00,
                                "Total Cost": 250.00,
                                "Plan Rows": 10000,
                                "Plan Width": 16,
                                "Actual Startup Time": 0.010,
                                "Actual Total Time": 12.345,
                                "Actual Rows": 10000,
                                "Actual Loops": 1,
                                "Filter": "(created_at > '2024-01-01'::date)",
                                "Rows Removed by Filter": 2144
                            },
                            {
                                "Node Type": "Hash",
                                "Parent Relationship": "Inner",
                                "Startup Cost": 25.00,
                                "Total Cost": 25.00,
                                "Plan Rows": 1000,
                                "Plan Width": 16,
                                "Actual Startup Time": 1.234,
                                "Actual Total Time": 1.234,
                                "Actual Rows": 1000,
                                "Actual Loops": 1,
                                "Plans": [
                                    {
                                        "Node Type": "Index Scan",
                                        "Parent Relationship": "Outer",
                                        "Scan Direction": "Forward",
                                        "Index Name": "users_active_idx",
                                        "Relation Name": "users",
                                        "Alias": "users",
                                        "Startup Cost": 0.42,
                                        "Total Cost": 25.00,
                                        "Plan Rows": 1000,
                                        "Plan Width": 16,
                                        "Actual Startup Time": 0.050,
                                        "Actual Total Time": 0.876,
                                        "Actual Rows": 1000,
                                        "Actual Loops": 1,
                                        "Index Cond": "(active = true)"
                                    }
                                ]
                            }
                        ]
                    },
                    "Planning Time": 1.234,
                    "Execution Time": 47.123
                }
            ];
            
            const query = `SELECT u.name, o.total 
FROM users u 
JOIN orders o ON u.id = o.user_id 
WHERE u.active = true 
  AND o.created_at > '2024-01-01'`;
            
            if (app && app._instance) {
                app._instance.proxy.updatePlan(JSON.stringify(plan, null, 2), query);
                console.log('Complex plan loaded');
            }
        }

        // Error state
        function loadErrorState() {
            const container = document.getElementById('pev2Container');
            container.innerHTML = '<div class="alert alert-danger m-3">Database connection not configured. Set DATABASE_URL environment variable.</div>';
            console.log('Error state loaded');
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkLibraries();
            initPEV2();
            
            // Auto-load sample plan after a short delay
            setTimeout(() => {
                loadSamplePlan();
            }, 500);
        });
    </script>
</body>
</html>
